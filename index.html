<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Audio Explorer</title>
  <style>
    :root {
      --bg: #0f1221;
      --panel: #171a2b;
      --muted: #8a90a6;
      --text: #e7ebfb;
      --accent: #6ea8fe;
      --warn: #f0ad4e;
      --error: #ff6b6b;
      --ok: #2ecc71;
      --border: #262a40;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #0c1020 0%, #0a0d1a 100%);
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(8px);
      background: rgba(10, 13, 26, 0.8);
      border-bottom: 1px solid var(--border);
    }
    .toolbar {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      align-items: center;
      padding: 12px 16px;
    }
    .toolbar h1 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: 0.2px;
    }
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    select, input[type="search"] {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
    }
    .content {
      padding: 12px 16px 32px;
    }
    .table-wrap {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: auto;
      background: rgba(17, 20, 36, 0.6);
      box-shadow: 0 1px 10px rgba(0,0,0,0.25);
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #121527;
      color: #c4c8da;
      text-align: left;
      font-weight: 600;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    tbody td {
      border-bottom: 1px solid var(--border);
      padding: 8px 12px;
      vertical-align: top;
    }
    tbody tr:hover {
      background: rgba(110, 168, 254, 0.07);
    }
    .col-text { min-width: 380px; max-width: 680px; }
    .col-small { width: 90px; white-space: nowrap; }
    .col-medium { min-width: 140px; }
    .audios {
      display: grid;
      grid-template-columns: repeat(1, minmax(240px, 1fr));
      gap: 8px 12px;
    }
    @media (min-width: 1200px) {
      .audios { grid-template-columns: repeat(2, minmax(240px, 1fr)); }
    }
    .audio-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
    }
    .audio-card h4 {
      margin: 0 0 6px 0;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
    }
    audio { width: 100%; height: 32px; }
    .status { font-size: 12px; color: var(--muted); }
    .status.missing { color: var(--error); font-weight: 600; }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 12px;
    }
    .count { color: var(--muted); font-size: 12px; }
    .sr-only { position: absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* Pagination */
    .pager {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      padding: 10px 4px;
      color: var(--muted);
    }
    .page-btn {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
    }
    .page-btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <header>
    <div class="toolbar">
      <h1>Audio Explorer</h1>
      <div class="controls">
        <label for="categorySelect" class="sr-only">Filter by category</label>
        <select id="categorySelect" aria-label="Filter by category">
          <option value="__ALL__">All categories</option>
        </select>
      </div>
      <div class="count" id="rowCount">0 rows</div>
    </div>
  </header>
  <main class="content">
    <div class="table-wrap">
      <table id="dataTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div id="pagination" class="pager"></div>
  </main>

  <script>
    // Minimal CSV parser supporting RFC-4180 basics: quoted fields with commas and escaped quotes
    function parseCSV(text) {
      const rows = [];
      let i = 0, field = '', row = [], inQuotes = false;
      const pushField = () => { row.push(field); field = ''; };
      const pushRow = () => { rows.push(row); row = []; };
      while (i < text.length) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i+1] === '"') { field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          } else {
            field += c; i++; continue;
          }
        } else {
          if (c === '"') { inQuotes = true; i++; continue; }
          if (c === ',') { pushField(); i++; continue; }
          if (c === '\n') { pushField(); pushRow(); i++; continue; }
          if (c === '\r') { // handle CRLF or lone CR
            if (text[i+1] === '\n') { i++; }
            pushField(); pushRow(); i++; continue;
          }
          field += c; i++;
        }
      }
      // Flush last field/row if not terminated by newline
      if (field.length > 0 || row.length > 0) { pushField(); pushRow(); }
      // Trim BOM from first cell if present
      if (rows.length && rows[0].length) {
        rows[0][0] = rows[0][0].replace(/^\uFEFF/, '');
      }
      return rows;
    }

    async function loadCSV(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error(`Failed to fetch ${path}: ${res.status}`);
      const txt = await res.text();
      const rows = parseCSV(txt).filter(r => r.length && r.some(v => v.trim() !== ''));
      if (rows.length < 2) return { headers: rows[0] || [], data: [] };
      const headers = rows[0];
      const data = rows.slice(1).map(r => Object.fromEntries(headers.map((h, idx) => [h, r[idx] ?? ''])));
      return { headers, data };
    }

    function basename(path) {
      if (!path) return '';
      const name = path.split('/').pop() || path;
      return name;
    }
    function stripExt(name) {
      return (name || '').replace(/\.[^.]+$/, '');
    }

    function buildAudioSources(gtPath) {
      const base = stripExt(basename(gtPath));
      return [
        { label: 'A', path: `./A/${base}.wav`, type: 'audio/wav' },
        { label: 'B', path: `./B/${base}.mp3`, type: 'audio/wav' },
        { label: 'C', path: `./C/${base}.wav`, type: 'audio/wav' },
        { label: 'D', path: `./D/${base}.wav`, type: 'audio/wav' },
        { label: 'E', path: `./E/${base}.wav`, type: 'audio/wav' },
        { label: 'F', path: `./F/${base}.wav`, type: 'audio/wav' },
        { label: 'G', path: `./G/${base}.wav`, type: 'audio/wav' },
        { label: 'H', path: `./H/${base}.wav`, type: 'audio/wav' },
        { label: 'I', path: `./I/${base}.wav`, type: 'audio/wav' },
        { label: 'J', path: `./J/${base}.wav`, type: 'audio/wav' },
      ];
    }

    function renderTable(headers, rows) {
      const thead = document.getElementById('tableHead');
      const tbody = document.getElementById('tableBody');
      thead.innerHTML = '';
      tbody.innerHTML = '';
      const fullHeaders = [...headers, 'Audios'];
      const trh = document.createElement('tr');
      for (const h of fullHeaders) {
        const th = document.createElement('th');
        th.textContent = h;
        if (h === 'text_to_synthesize') th.classList.add('col-text');
        if (h === 'category' || h === 'language' || h === 'evolution_depth') th.classList.add('col-small');
        // Hide gt_audio_path from headers by not including it in `headers`
        if (h === 'gt_audio_path') th.classList.add('col-medium');
        trh.appendChild(th);
      }
      thead.appendChild(trh);

      for (const row of rows) {
        const tr = document.createElement('tr');
        for (const h of headers) {
          const td = document.createElement('td');
          let val = row[h] ?? '';
          if (h === 'text_to_synthesize') {
            // Keep long text readable
            const div = document.createElement('div');
            div.className = 'col-text';
            div.textContent = val;
            td.appendChild(div);
          } else if (h === 'evolution_depth') {
            const badge = document.createElement('span');
            badge.className = 'pill';
            badge.textContent = String(val);
            td.appendChild(badge);
          } else {
            td.textContent = val;
          }
          tr.appendChild(td);
        }
        const tdAudios = document.createElement('td');
        const grid = document.createElement('div');
        grid.className = 'audios';
        const sources = buildAudioSources(row['gt_audio_path']);
        for (const s of sources) {
          const card = document.createElement('div');
          card.className = 'audio-card';
          const title = document.createElement('h4');
          title.textContent = s.label;
          const player = document.createElement('audio');
          player.controls = true;
          player.preload = 'none';
          player.src = s.path;
          player.onerror = () => {
            player.replaceWith(Object.assign(document.createElement('div'), {
              className: 'status missing',
              textContent: 'Missing: ' + s.path
            }));
          };
          const status = document.createElement('div');
          status.className = 'status';
          status.textContent = s.path;
          card.appendChild(title);
          card.appendChild(player);
          card.appendChild(status);
          grid.appendChild(card);
        }
        tdAudios.appendChild(grid);
        tr.appendChild(tdAudios);
        tbody.appendChild(tr);
      }
    }

    function uniqueCategories(data) {
      return Array.from(new Set(data.map(r => (r.category ?? '').trim()).filter(Boolean))).sort((a,b) => a.localeCompare(b));
    }

    // Pagination + filtering state
    const state = { headers: [], displayHeaders: [], data: [], filtered: [], pageSize: 10, page: 1 };

    function updatePagination(pageCount) {
      const pager = document.getElementById('pagination');
      pager.innerHTML = '';
      const prev = document.createElement('button');
      prev.className = 'page-btn';
      prev.textContent = 'Prev';
      prev.disabled = state.page <= 1 || pageCount === 0;
      prev.addEventListener('click', () => { if (state.page > 1) { state.page--; render(); } });

      const next = document.createElement('button');
      next.className = 'page-btn';
      next.textContent = 'Next';
      next.disabled = state.page >= pageCount || pageCount === 0;
      next.addEventListener('click', () => { if (state.page < pageCount) { state.page++; render(); } });

      const label = document.createElement('span');
      label.textContent = pageCount === 0 ? 'No pages' : `Page ${state.page} of ${pageCount}`;

      pager.appendChild(prev);
      pager.appendChild(label);
      pager.appendChild(next);
    }

    function render() {
      const total = state.filtered.length;
      const pageCount = Math.max(1, Math.ceil(total / state.pageSize));
      if (total === 0) {
        state.page = 1;
      } else if (state.page > pageCount) {
        state.page = pageCount;
      }
      const startIdx = total === 0 ? 0 : (state.page - 1) * state.pageSize;
      const endIdx = total === 0 ? 0 : Math.min(total, startIdx + state.pageSize);
      const pageRows = total === 0 ? [] : state.filtered.slice(startIdx, startIdx + state.pageSize);
      renderTable(state.displayHeaders, pageRows);
      const rc = document.getElementById('rowCount');
      if (total === 0) rc.textContent = '0 rows';
      else rc.textContent = `Showing ${startIdx + 1}\u2013${endIdx} of ${total} rows`;
      updatePagination(total === 0 ? 0 : pageCount);
    }

    function applyFilter(allData, headers) {
      const sel = document.getElementById('categorySelect');
      const val = sel.value;
      state.filtered = val === '__ALL__' ? allData : allData.filter(r => (r.category ?? '').trim() === val);
      state.page = 1;
      render();
    }

    (async function init() {
      try {
        const { headers, data } = await loadCSV('listen.csv');
        if (!headers || !headers.length) {
          document.getElementById('tableHead').innerHTML = '<tr><th>No data</th></tr>';
          return;
        }
        // Init state
        state.headers = headers;
        state.displayHeaders = headers.filter(h => h !== 'gt_audio_path');
        state.data = data;
        state.filtered = data;

        // Populate category dropdown
        const select = document.getElementById('categorySelect');
        for (const c of uniqueCategories(state.data)) {
          const opt = document.createElement('option');
          opt.value = c; opt.textContent = c;
          select.appendChild(opt);
        }
        select.addEventListener('change', () => applyFilter(state.data, state.headers));
        // Initial render
        render();
      } catch (err) {
        console.error(err);
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = `<tr><td style="color: var(--error); padding: 16px;">Failed to load CSV: ${String(err)}</td></tr>`;
      }
    })();
  </script>
</body>
</html>
